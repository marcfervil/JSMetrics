<!DOCTYPE html>
<html>
	<head>

		<meta charset="UTF-8">
		<title>JSMetrics</title>
		<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="../html/style.css">

	</head>
	<body>
		<div id="app" class="app">
			<div id="packageViewer" class="packageViewer fillHeight">

				<div class="appHeading2">
					<h1 style="opacity: 0.4;">Files</h1>
				</div>
				<div style="flex: 1;overflow-x: hidden;padding:10px">
					<package v-if="metrics!=null" style="margin-left:25px;"  v-bind:file-data="metrics.files"></package><br>
					<div v-if="metrics==null" style="opacity: 0.4;">
						<h3 style="margin:0;padding:0;">It looks like you don't have a project open!</h3><br>
						To open a project click <a v-on:click="open">here</a> or go to File > Open Project
					</div>
				</div>
			</div>


			<metrics v-if="viewMetrics!=null" class="metricsViewer fillHeight" v-bind:metric-data="viewMetrics"></metrics>
			<about v-else></about>
		</div>
	</body>
</html>
<script type="text/javascript" src="../libs/vue.js"></script>
<script src="../libs/fa.js" crossorigin="anonymous"></script>
<script src="../html/components/about.js" crossorigin="anonymous"></script>
<script type="text/javascript">
	const Metrics = require('../src/metrics.js')
	const { ipcRenderer } = require('electron');

	Vue.component('package', {

		props:["file-data"],
		data: function(){
			return {
				expanded: [],
				click: 0
			}
		},

		template: `
			<div  >

				<div v-for="(value, name) in fileData.files">
					<div v-if='typeof value=="string"' class="file">
						<span style="opacity: 0.5;">
							&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-file-code"></i> {{value}}
						</span>
					</div>
					<div v-else-if='typeof value=="object"' class="folder">
						<i v-if="expanded.includes(value.path)" style="opacity: 0.5;" class= "fas fa-angle-up fa-rotate-180"></i>
						<i v-else style="opacity: 0.5;" class= "fas fa-angle-up fa-rotate-90"></i>
						<span style="opacity: 0.5;"class="folderItem" v-on:click="expandFolder(value.path)">
							<i class="fas fa-folder"></i> {{fileFromPath(value.path)}}
						</span>
						<package style="margin-left:25px"v-if="expanded.includes(value.path)" v-bind:file-data="value"></package>
					</div>

				</div>



			</div>
		`,
		methods: {
			fileFromPath: function(fullPath){
				return fullPath.replace(/^.*[\\\/]/, '');
			},
			expandFolder: function(file){
			//	console.log(mainApp.metrics);
				if(this.click==2)return;
				this.click+=1;
				this.timeout = setTimeout(() => {
					this.click -=1;
					if(this.click==1){
						mainApp.viewMetrics = mainApp.metrics.explorePackage(file);
						if(!this.expanded.includes(file))this.expanded.push(file);
						this.click = 0;
						clearTimeout(this.timeout);
					}else if(this.click==0){
						if(this.expanded.includes(file)){
							this.expanded.splice(this.expanded.indexOf(file), 1);
						}else{
							this.expanded.push(file);
						}
						this.click = 0;
						clearTimeout(this.timeout);
					}
				}, 200);

			}

		}
	});

	function fileFromPath (fullPath){
		return fullPath.replace(/^.*[\\\/]/, '');
	}

	Vue.component('metrics', {

		props:["metric-data"],

		template: `
			<div>

				<div class="appHeading"><h1>{{fileFromPath(metricData.files.path)}} metrics</h1></div>

				<div class="metricsContent">
					<h2>Metrics </h2>
					<span class="bubble" v-for = "metric in metricData.getAll()">
						<span style="opacity:0.5;">{{metric.name}}</span> <br> <h1>{{metric.value}}</h1> <br>
					</span>
					<br style="clear:both">

					<h2>Classes </h2>
					<div>
						<span class="bubble long" v-for = "(hiarchy, fileName) in metricData.inheritanceTree" v-if = "typeof fileName == 'string'">
							<span style="opacity:0.5;">Class</span> <br> <h3>{{fileName}}</h3> <br>
						</span>
					</div>
				</div>

			</div>
		`,
		methods: {
			fileFromPath: function(fullPath){
				return fullPath.replace(/^.*[\\\/]/, '');
			},

		}
	});



	var mainApp = new Vue({
		el: '#app',
		data: {
			metrics: null,
			viewMetrics : null
		},
		created: function(){
			ipcRenderer.send('menu');
		},
		methods: {
			fileBrowse: function () {
				ipcRenderer.send('selectDirectory');
			},
			fileFromPath:function(fullPath){
				return fullPath.replace(/^.*[\\\/]/, '');
			},
			oepn: function(){
				ipcRenderer.send('selectDirectory');
			}
		}
	});





	ipcRenderer.on('metrics', (event, arg) => {
		//console.log("beans");
	//	console.log(arg);

  		mainApp.metrics = new Metrics(arg, true);
		//console.log(new Metrics(arg));
		mainApp.viewMetrics = mainApp.metrics.explorePackage(mainApp.metrics.files.path);

	});
</script>
